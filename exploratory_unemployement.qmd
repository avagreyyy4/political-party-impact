---
title: "initial look"
editor: visual
---

```{r, message = FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(forcats)
library(tidytext)
library(scales)
library(lubridate)
library(stringr)
```

```{r}
unemployement <- read_csv("data/unemployement_rate_by_state.csv")
```

There are 16 states that voted blue in every presidential election since 2000, and there are 20 states that have voted red in every presidential election since 2000.

```{r}
consistent_blue <- c("California", "Oregon", "Washington", "Minnesota", "Illinois", "New York", "Vermont", "New Jersey", "Maine", "Rhode Island", "Maryland", "Delaware", "District of Columbia", "Conneticut", "Hawaii", "Massachusetts")

consistent_red <- c("Alaska", "Alabama", "Arkansas", "Idaho", "Kansas", "Kentucky", "Louisiana", "Missouri", "Mississippi", "Montana", "Nebraska", "North Dakota", "Oklahoma", "South Carolina", "South Dakota", "Tennesse", "Texas", "Utah", "Wyoming", "West Virginia")

all_consistent <- union(consistent_blue, consistent_red)

biden_years <- c(2024, 2023, 2022, 2021)
trump_years <- c(2020, 2019, 2018, 2017)
obama_years <- c(2016, 2015, 2014, 2013, 
                 2012, 2011, 2010, 2009)
bush_years <- c(2008, 2007, 2006, 2005, 
                 2004, 2003, 2002, 2001)
```

```{r}
#filtering and feature engineering
unemployement_filtered <- unemployement |> 
  filter(State %in% all_consistent) |>
  pivot_longer(cols = `2024`:`2001`, 
               names_to = 'Year', 
               values_to = 'unemployement_rate')|>
  mutate(
    vote = case_when(
      State %in% consistent_red ~ "Republican",
      State %in% consistent_blue ~ "Democrat",
      State == 'United States' ~ "United States"),
    administration = case_when(
      Year %in% biden_years ~ "Biden",
      Year %in% trump_years ~ "Trump",
      Year %in% obama_years ~ "Obama",
      Year %in% bush_years ~ "Bush"
      
    )
  )|> select(-"2000") 

unemployement_filtered$Year <- as.Date(paste0(unemployement_filtered$Year, "-01-01"))

unemployement_filtered <- unemployement_filtered|>
  group_by(administration, State)|>
  reframe(
    start_rate = unemployement_rate[which.min(Year)],
    end_rate = unemployement_rate[which.max(Year)],
    difference = end_rate-start_rate,
    percent_change = (end_rate-start_rate)/end_rate,
    vote = first(vote)
    
  ) |> distinct()

unemployement_us_avg <- unemployement_filtered |>
  mutate(
    dif_from_us = difference - case_when(
      administration == "Biden" ~ -0.013,
      administration == "Trump" ~  0.037,
      administration == "Obama" ~ -0.044,
      administration == "Bush"  ~  0.011,
      TRUE ~ NA_real_
    ),
    dif_from_us = round(dif_from_us, 3))
  
```

```{r}
#| fig.height: 15

unemployement_us_avg <- unemployement_us_avg |>
  mutate(administration = factor(
    administration,
    levels = c("Bush", "Obama", "Trump", "Biden")  
  )) |> mutate(State_in_panel = reorder_within(State, dif_from_us, administration))

unemployement_us_avg |> ggplot(aes(x = dif_from_us, y = State_in_panel, color = vote)) + geom_point() +
  facet_wrap(~administration, scales = "free_y") + scale_color_manual(
    values = c(
      "Republican" = "red",
      "Democrat"   = "blue",
      "United States" = "gray"
    )) + scale_y_reordered() + labs(y = "State", x = "Average Unemployement Rate",
                                    title = "Average Unemployement Rate Throughout 21st Century Administrations")
```

```{r}
#| fig.height: 15

unemployement_us_avg |> mutate(State_in_panel = reorder_within(State, percent_change, administration))|> ggplot(aes(x = percent_change, y = State_in_panel, color = vote)) + geom_point() +
  facet_wrap(~administration, scales = "free_y") + scale_color_manual(
    values = c(
      "Republican" = "red",
      "Democrat"   = "blue",
      "United States" = "gray"
    )) + scale_y_reordered() + labs(y = "State", x = "percent_change in Unemployement",
                                    title = "percent_change in Unemployement Throughout 21st Century Administrations", caption = "percent_change calculated as last year in office minus first year in office (smaller values show decline in unemployement throughout years)")
```

```{r}
rate_colors <- c("lightgreen", "pink")

mosaic2 <- unemployement_us_avg |>
  mutate(increase = ifelse(dif_from_us > 0, 1, 0))|>
  mutate(administration = case_when(
    administration == "Biden" ~ "Democrat",
    administration == "Obama" ~ "Democrat",
    administration == "Trump" ~ "Republican",
    administration == "Bush" ~ "Republican"
  ))|>
  select(vote, increase, administration) |> 
  group_by(vote, increase, administration) |>
  summarize(Freq = n()) |> ungroup()

vcd::mosaic(increase ~ vote + administration, mosaic2, direction = c("v", "v", "h"),
            highlighting_fill = rate_colors)

```

```{r}
mapping <- unemployement_us_avg |> mutate(state_lower = tolower(State))
us_map <- map_data("state") 

mapping_joined <- us_map |>
  left_join(mapping, by = c("region" = "state_lower"),
            relationship = "many-to-many")

lim <- max(abs(mapping_joined$dif_from_us), na.rm = TRUE)

four_maps <- ggplot(mapping_joined, aes(long, lat, group = group, fill = dif_from_us, rm.na=TRUE)) +
    geom_polygon(color = "white", linewidth = 0.2) +
    coord_map("albers", lat0 = 39, lat1 = 45) +
    facet_wrap(~ administration, ncol = 2) +   # <-- or ~ Administration
    scale_fill_gradient2(
        name = "State − US change",
        low = "darkgreen", mid = "white", high = "red",
        midpoint = 0,
        limits = c(-lim, lim),
,   # if dif_from_us is proportions
        oob = squish, na.value = "grey90"
    ) +
    theme_minimal(base_size = 12) +
    theme(
        panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r}
four_maps
```

```{r}
library(dplyr)
library(ggplot2)
library(forcats)
library(scales)

# order: most volatile (highest SD of gap) at the top
state_order <- unemployement_us_avg %>%
  group_by(State) %>%
  summarise(var_gap = sd(dif_from_us, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(var_gap)) %>%
  pull(State)

lim <- max(abs(unemployement_us_avg$dif_from_us), na.rm = TRUE)

difference_visual <- ggplot(
  unemployement_us_avg,
  aes(x = administration,
      y = factor(State, levels = state_order),   # apply ordering here
      fill = dif_from_us)
) +
  geom_tile(color = "white") +
  labs(title = "State − U.S. unemployment gap by administration",
       x = NULL, y = NULL) +
  scale_fill_gradient2(
    name = "State − US change",
    low = "darkgreen", mid = "white", high = "red",
    midpoint = 0,
    limits = c(-lim, lim),
    labels = label_percent(accuracy = 0.001),   # no rounding; or keep 0.1%
    na.value = "grey90"
  ) +
  theme_bw() +
  theme(panel.grid = element_blank())
```

```{r}
difference_visual
```

Seems for republicans states specifically in the middle country do better: idaho, wyoming, nebraska, oklahoma etc. Look into these states

For democrats: costal cities do better

Also, coastal cities seem to have the least variation ==\> are fine off usually regardless of which party is in power

```{r}
library(tidyverse)
library(tidycensus)
library(choroplethr)
library(choroplethrMaps)

# Load your Census API key
census_api_key(Sys.getenv("CENSUS_API_KEY"), install = FALSE)

# ----- Pull ACS 2024 Industry Data -----
df <- get_acs(
  geography = "state",
  table = "C24050",
  survey = "acs1",
  year = 2012,
  output = "tidy"
)

# ----- Total employment (C24050_001) -----
totals <- df %>%
  filter(variable == "C24050_001") %>%
  select(NAME, total = estimate)

# ----- Agriculture employment (C24050_002) -----
ag <- df %>%
  filter(variable == "C24050_002") %>%
  select(NAME, ag = estimate)

# ----- Compute percentage -----
ag_pct <- ag %>%
  left_join(totals, by = "NAME") %>%
  mutate(
    pct = ag / total,
    region = tolower(NAME)   # choroplethr requires lowercase state names
  ) %>%
  select(region, value = pct)


```

```{r}
all_states <- c(state.name, "District of Columbia")
allowed_states <- c(consistent_blue, consistent_red)
blank_states <- setdiff(all_states, allowed_states)
```

```{r}
ag_pct2 <- ag_pct %>%
  mutate(value = ifelse(region %in% tolower(blank_states), NA, value))

state_choropleth(
  ag_pct2,
  title  = "Agriculture Employment Share (ACS 2024)",
  legend = "Percent of Workforce"
)

```

```{r}
one_admin <- "Obama"

library(tidyverse)
library(ggplot2)
library(scales)
library(maps)

# ---- choose which president you want ----
one_admin <- "Obama"    # change to Bush, Obama, Trump, Biden

# ---- filter to just that administration ----
mapping_one <- unemployement_us_avg %>%
  filter(administration == one_admin) %>%
  mutate(state_lower = tolower(State))

# ---- bring in map data ----
us_map <- map_data("state")

mapping_joined <- us_map %>%
  left_join(mapping_one, 
            by = c("region" = "state_lower"),
            relationship = "many-to-many")

# ---- symmetric fill limits ----
lim <- max(abs(mapping_joined$dif_from_us), na.rm = TRUE)

# ---- plot ----
one_map <- ggplot(mapping_joined, 
                  aes(long, lat, group = group, fill = dif_from_us)) +
  geom_polygon(color = "white", linewidth = 0.2) +
  coord_map("albers", lat0 = 39, lat1 = 45) +
  scale_fill_gradient2(
    name = "State − US change",
    low = "darkgreen", mid = "white", high = "red",
    midpoint = 0,
    limits = c(-lim, lim),
    oob = squish,
    na.value = "grey90"
  ) +
  labs(
    title = paste("State − U.S. Unemployment Gap During", one_admin),
    x = NULL, y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "right"
  )

one_map

```

```{r}
df <- get_acs(
  geography = "state",
  table = "C24050",
  survey = "acs1",
  year = 2024,
  output = "tidy"
)

# ----- Total employment (C24050_001) -----
totals <- df %>%
  filter(variable == "C24050_001") %>%
  select(NAME, total = estimate)

# ----- Agriculture employment (C24050_002) -----
ag <- df %>%
  filter(variable == "C24050_002") %>%
  select(NAME, ag = estimate)

# ----- Compute percentage -----
ag_pct <- ag %>%
  left_join(totals, by = "NAME") %>%
  mutate(
    pct = ag / total,
    region = tolower(NAME)   # choroplethr requires lowercase state names
  ) %>%
  select(region, value = pct)

```

```{r}
ag_pct2 <- ag_pct %>%
  mutate(value = ifelse(region %in% tolower(blank_states), NA, value))

state_choropleth(
  ag_pct2,
  title  = "Agriculture Employment Share (ACS 2024)",
  legend = "Percent of Workforce"
)

```
